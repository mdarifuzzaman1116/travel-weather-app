const axios=require("axios"),cheerio=require("cheerio"),fs=require("fs"),path=require("path"),{createObjectCsvWriter:createObjectCsvWriter}=require("csv-writer");class TravelDataScraper{constructor(){this.cache=new Map,this.cacheExpiry=864e5,this.csvPath=path.join(__dirname,"travel_data.csv"),this.scrapedDataPath=path.join(__dirname,"scraped_destinations.json")}async getCountryTravelInfo(country){const cacheKey=country.toLowerCase(),cached=this.cache.get(cacheKey);if(cached&&Date.now()-cached.timestamp<this.cacheExpiry)return cached.data;const data=await this.scrapeMultipleSources(country);return data&&this.cache.set(cacheKey,{data:data,timestamp:Date.now()}),data}async scrapeMultipleSources(country){const scrapedData=await this.loadScrapedData(country);if(scrapedData)return scrapedData;const results=await Promise.allSettled([this.scrapeTravelGuides(country),this.scrapeWeatherData(country),this.getTravelDataFromStaticSource(country)]),combinedData={country:country,monthlyData:{},bestMonths:[],sources:[],scrapedAt:(new Date).toISOString()};return results.forEach(((result,index)=>{if("fulfilled"===result.status&&result.value){const sourceName=["TravelGuides","WeatherData","Database"][index];combinedData.sources.push(sourceName),result.value.monthlyData&&Object.keys(result.value.monthlyData).forEach((month=>{combinedData.monthlyData[month]?combinedData.monthlyData[month]={...combinedData.monthlyData[month],...result.value.monthlyData[month]}:combinedData.monthlyData[month]=result.value.monthlyData[month]})),result.value.bestMonths&&combinedData.bestMonths.push(...result.value.bestMonths),result.value.scenicFocus&&(combinedData.scenicFocus=result.value.scenicFocus),result.value.avgBudget&&(combinedData.avgBudget=result.value.avgBudget)}})),combinedData.bestMonths=[...new Set(combinedData.bestMonths)],combinedData.sources.length>0&&(await this.saveScrapedData(combinedData),await this.saveToCsv(combinedData)),combinedData.sources.length>0?combinedData:null}async scrapeTravelGuides(country){try{const response=await axios.get(`https://traveltriangle.com/blog/best-time-to-visit-${country.toLowerCase().replace(/\s+/g,"-")}`,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"},timeout:1e4}),$=cheerio.load(response.data);return this.parseTravelGuideData($,country)}catch(error){return console.log(`Travel guide scraping failed for ${country}:`,error.message),null}}parseTravelGuideData($,country){const monthlyData={},bestMonths=[];return $("h2, h3").each(((i,elem)=>{const text=$(elem).text().toLowerCase();["january","february","march","april","may","june","july","august","september","october","november","december"].forEach((month=>{if(text.includes(month)){const monthCapitalized=month.charAt(0).toUpperCase()+month.slice(1),nextParagraph=$(elem).next("p").text(),tempMatch=nextParagraph.match(/(\d+)[-–](\d+)\s*[°]?[CF]/i),temp=tempMatch?`${tempMatch[1]}-${tempMatch[2]}`:null;(text.includes("best")||nextParagraph.toLowerCase().includes("best time"))&&bestMonths.push(monthCapitalized),monthlyData[monthCapitalized]={temp:temp,description:nextParagraph.substring(0,200)}}}))})),Object.keys(monthlyData).length>0?{monthlyData:monthlyData,bestMonths:bestMonths}:null}async scrapeWeatherData(country){try{const countrySlug=country.toLowerCase().replace(/\s+/g,"-"),response=await axios.get(`https://www.holiday-weather.com/${countrySlug}/averages/`,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"},timeout:1e4}),$=cheerio.load(response.data);return this.parseWeatherData($,country)}catch(error){return console.log(`Weather data scraping failed for ${country}:`,error.message),null}}parseWeatherData($,country){const monthlyData={},months=["January","February","March","April","May","June","July","August","September","October","November","December"];return $("table tr").each(((i,row)=>{const cells=$(row).find("td");if(cells.length>=2){const monthText=$(cells[0]).text().trim(),month=months.find((m=>monthText.includes(m)));if(month){const temp=$(cells[1]).text().trim(),rainfall=$(cells[2])?$(cells[2]).text().trim():"N/A";monthlyData[month]={temp:temp,rainfall:rainfall}}}})),Object.keys(monthlyData).length>0?{monthlyData:monthlyData}:null}getTravelDataFromStaticSource(country){const data={maldives:{monthlyData:{January:{temp:"82-88",rainfall:"Low",crowd:"High",rating:"Excellent"},February:{temp:"82-88",rainfall:"Low",crowd:"High",rating:"Excellent"},March:{temp:"83-89",rainfall:"Low",crowd:"Medium",rating:"Excellent"},April:{temp:"83-90",rainfall:"Medium",crowd:"Low",rating:"Good"},May:{temp:"82-88",rainfall:"High",crowd:"Low",rating:"Fair"},June:{temp:"81-87",rainfall:"High",crowd:"Low",rating:"Fair"},July:{temp:"81-87",rainfall:"High",crowd:"Medium",rating:"Fair"},August:{temp:"81-87",rainfall:"High",crowd:"Medium",rating:"Fair"},September:{temp:"81-87",rainfall:"High",crowd:"Low",rating:"Fair"},October:{temp:"81-87",rainfall:"High",crowd:"Low",rating:"Fair"},November:{temp:"81-87",rainfall:"Medium",crowd:"Medium",rating:"Good"},December:{temp:"82-88",rainfall:"Low",crowd:"High",rating:"Excellent"}},bestMonths:["January","February","March","December"],scenicFocus:"Beaches, diving, water sports",avgBudget:"$3500-$6000"},japan:{monthlyData:{January:{temp:"36-47",rainfall:"Low",crowd:"Low",rating:"Good"},February:{temp:"37-50",rainfall:"Low",crowd:"Low",rating:"Good"},March:{temp:"42-57",rainfall:"Medium",crowd:"High",rating:"Excellent"},April:{temp:"50-66",rainfall:"Medium",crowd:"High",rating:"Excellent"},May:{temp:"59-73",rainfall:"Medium",crowd:"Medium",rating:"Good"},June:{temp:"66-77",rainfall:"High",crowd:"Low",rating:"Fair"},July:{temp:"72-83",rainfall:"High",crowd:"Medium",rating:"Fair"},August:{temp:"75-86",rainfall:"High",crowd:"Medium",rating:"Fair"},September:{temp:"68-79",rainfall:"High",crowd:"Low",rating:"Fair"},October:{temp:"57-70",rainfall:"Medium",crowd:"High",rating:"Excellent"},November:{temp:"48-61",rainfall:"Low",crowd:"High",rating:"Excellent"},December:{temp:"39-52",rainfall:"Low",crowd:"Low",rating:"Good"}},bestMonths:["March","April","October","November"],scenicFocus:"Cherry blossoms, temples, fall colors",avgBudget:"$2500-$4500"},thailand:{monthlyData:{January:{temp:"70-90",rainfall:"Low",crowd:"High",rating:"Excellent"},February:{temp:"73-92",rainfall:"Low",crowd:"High",rating:"Excellent"},March:{temp:"75-95",rainfall:"Low",crowd:"Medium",rating:"Good"},April:{temp:"77-95",rainfall:"Medium",crowd:"Low",rating:"Fair"},May:{temp:"77-93",rainfall:"High",crowd:"Low",rating:"Fair"},June:{temp:"77-91",rainfall:"High",crowd:"Low",rating:"Fair"},July:{temp:"77-90",rainfall:"High",crowd:"Low",rating:"Fair"},August:{temp:"77-90",rainfall:"High",crowd:"Low",rating:"Fair"},September:{temp:"76-89",rainfall:"High",crowd:"Low",rating:"Fair"},October:{temp:"76-88",rainfall:"High",crowd:"Low",rating:"Fair"},November:{temp:"74-88",rainfall:"Medium",crowd:"High",rating:"Excellent"},December:{temp:"71-87",rainfall:"Low",crowd:"High",rating:"Excellent"}},bestMonths:["November","December","January","February"],scenicFocus:"Beaches, temples, street food",avgBudget:"$1500-$2500"},iceland:{monthlyData:{January:{temp:"27-35",rainfall:"Medium",crowd:"Low",rating:"Fair"},February:{temp:"28-37",rainfall:"Medium",crowd:"Low",rating:"Fair"},March:{temp:"30-39",rainfall:"Medium",crowd:"Low",rating:"Good"},April:{temp:"34-43",rainfall:"Low",crowd:"Low",rating:"Good"},May:{temp:"40-50",rainfall:"Low",crowd:"Medium",rating:"Excellent"},June:{temp:"45-55",rainfall:"Low",crowd:"High",rating:"Excellent"},July:{temp:"48-57",rainfall:"Low",crowd:"High",rating:"Excellent"},August:{temp:"47-56",rainfall:"Low",crowd:"High",rating:"Excellent"},September:{temp:"42-51",rainfall:"Medium",crowd:"Medium",rating:"Good"},October:{temp:"37-44",rainfall:"Medium",crowd:"Low",rating:"Good"},November:{temp:"32-39",rainfall:"Medium",crowd:"Low",rating:"Fair"},December:{temp:"28-36",rainfall:"Medium",crowd:"Low",rating:"Fair"}},bestMonths:["June","July","August","September"],scenicFocus:"Northern lights, glaciers, hot springs",avgBudget:"$3000-$5000"},greece:{monthlyData:{January:{temp:"45-55",rainfall:"High",crowd:"Low",rating:"Fair"},February:{temp:"46-57",rainfall:"Medium",crowd:"Low",rating:"Fair"},March:{temp:"48-61",rainfall:"Medium",crowd:"Low",rating:"Good"},April:{temp:"53-68",rainfall:"Low",crowd:"Medium",rating:"Excellent"},May:{temp:"61-77",rainfall:"Low",crowd:"High",rating:"Excellent"},June:{temp:"68-84",rainfall:"Low",crowd:"High",rating:"Excellent"},July:{temp:"73-90",rainfall:"Low",crowd:"High",rating:"Good"},August:{temp:"73-90",rainfall:"Low",crowd:"High",rating:"Good"},September:{temp:"66-84",rainfall:"Low",crowd:"Medium",rating:"Excellent"},October:{temp:"59-73",rainfall:"Medium",crowd:"Low",rating:"Good"},November:{temp:"52-64",rainfall:"High",crowd:"Low",rating:"Fair"},December:{temp:"47-57",rainfall:"High",crowd:"Low",rating:"Fair"}},bestMonths:["May","June","September","October"],scenicFocus:"Islands, ancient ruins, beaches",avgBudget:"$2000-$3500"}}[country.toLowerCase()];return data?Promise.resolve(data):Promise.resolve(null)}async searchCountries(query){const queryLower=query.toLowerCase();return["Maldives","Japan","Thailand","Iceland","Greece","Italy","Spain","France","Portugal","Croatia","Turkey","Morocco","Egypt","Bali","Vietnam","Cambodia","Australia","New Zealand","Fiji","Costa Rica","Mexico","Peru","Brazil","Argentina","Chile","South Africa","Kenya","Tanzania","Seychelles","Mauritius","Norway","Sweden","Switzerland","Austria","Germany","United Kingdom","Ireland","Scotland","India","Sri Lanka","UAE","Jordan","Oman","Indonesia","Malaysia","Singapore","South Korea","China","Nepal","Bhutan","Canada","USA"].filter((country=>country.toLowerCase().includes(queryLower)))}async saveScrapedData(data){try{let allData={};if(fs.existsSync(this.scrapedDataPath)){const existing=fs.readFileSync(this.scrapedDataPath,"utf8");allData=JSON.parse(existing)}allData[data.country.toLowerCase()]=data,fs.writeFileSync(this.scrapedDataPath,JSON.stringify(allData,null,2)),console.log(`Saved scraped data for ${data.country}`)}catch(error){console.error("Error saving scraped data:",error)}}async loadScrapedData(country){try{if(!fs.existsSync(this.scrapedDataPath))return null;const data=fs.readFileSync(this.scrapedDataPath,"utf8"),countryData=JSON.parse(data)[country.toLowerCase()];if(countryData){const scrapedAt=new Date(countryData.scrapedAt),age=Date.now()-scrapedAt.getTime();if(age<6048e5)return console.log(`Using cached scraped data for ${country}`),countryData}return null}catch(error){return console.error("Error loading scraped data:",error),null}}async saveToCsv(data){try{const records=[];if(Object.keys(data.monthlyData).forEach((month=>{const monthData=data.monthlyData[month];records.push({country:data.country,month:month,temperature:monthData.temp||"N/A",rainfall:monthData.rainfall||"N/A",crowd:monthData.crowd||"N/A",rating:monthData.rating||"N/A",description:monthData.description||"",scenicFocus:data.scenicFocus||"",avgBudget:data.avgBudget||"",bestMonth:data.bestMonths.includes(month)?"Yes":"No",sources:data.sources.join(", "),scrapedAt:data.scrapedAt||(new Date).toISOString()})})),0===records.length)return;const fileExists=fs.existsSync(this.csvPath);let existingRecords=[];if(fileExists){const lines=fs.readFileSync(this.csvPath,"utf8").split("\n").filter((line=>line.trim()));if(lines.length>1){const headers=lines[0].split(",");existingRecords=lines.slice(1).map((line=>{const values=line.split(","),record={};return headers.forEach(((header,i)=>{record[header.trim()]=values[i]?values[i].trim():""})),record})),existingRecords=existingRecords.filter((r=>r.country!==data.country))}}const allRecords=[...existingRecords,...records],csvWriter=createObjectCsvWriter({path:this.csvPath,header:[{id:"country",title:"country"},{id:"month",title:"month"},{id:"temperature",title:"temperature"},{id:"rainfall",title:"rainfall"},{id:"crowd",title:"crowd"},{id:"rating",title:"rating"},{id:"description",title:"description"},{id:"scenicFocus",title:"scenicFocus"},{id:"avgBudget",title:"avgBudget"},{id:"bestMonth",title:"bestMonth"},{id:"sources",title:"sources"},{id:"scrapedAt",title:"scrapedAt"}]});await csvWriter.writeRecords(allRecords),console.log(`Saved data to CSV: ${this.csvPath}`)}catch(error){console.error("Error saving to CSV:",error)}}async loadFromCsv(){try{if(!fs.existsSync(this.csvPath))return{};const lines=fs.readFileSync(this.csvPath,"utf8").split("\n").filter((line=>line.trim()));if(lines.length<2)return{};lines[0].split(",").map((h=>h.trim()));const data={};return lines.slice(1).forEach((line=>{const values=line.split(","),country=values[0],month=values[1];data[country]||(data[country]={country:country,monthlyData:{},bestMonths:[],sources:[],scenicFocus:"",avgBudget:""}),data[country].monthlyData[month]={temp:values[2],rainfall:values[3],crowd:values[4],rating:values[5],description:values[6]},"Yes"===values[9]&&data[country].bestMonths.push(month),data[country].scenicFocus=values[7],data[country].avgBudget=values[8],data[country].sources=values[10]?values[10].split(", "):[]})),data}catch(error){return console.error("Error loading from CSV:",error),{}}}getCsvPath(){return this.csvPath}}module.exports=TravelDataScraper;